# SDK Release Orchestrator
# Triggered by pushing a v* tag (e.g., v1.2.0).
# Runs lint centrally, then calls sub-workflows in parallel for:
#   - Android example app build (debug APK)
#   - NPM package tarball
#   - iOS example app build (IPA)
# Finally creates a GitHub Release with all artifacts.

name: SDK - Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  actions: read

jobs:
  # ──────────────────────────────────────────────────────────
  # 1. Central lint (runs once, sub-workflows skip their own)
  # ──────────────────────────────────────────────────────────
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  # ──────────────────────────────────────────────────────────
  # 2. Parallel builds via reusable workflows (workflow_call)
  #    Artifacts are shared within this workflow run.
  # ──────────────────────────────────────────────────────────

  build-android:
    needs: [lint]
    uses: ./.github/workflows/sdk-android.yml
    secrets: inherit

  build-sdk:
    needs: [lint]
    uses: ./.github/workflows/sdk-sdk.yml
    secrets: inherit

  build-ios:
    needs: [lint]
    uses: ./.github/workflows/sdk-ios.yml
    secrets: inherit

  # ──────────────────────────────────────────────────────────
  # 3. Create GitHub Release with all artifacts
  # ──────────────────────────────────────────────────────────
  create-release:
    runs-on: ubuntu-latest
    needs: [build-android, build-sdk, build-ios]
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag: $TAG_NAME, Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "All downloaded artifacts:"
          find artifacts -type f | sort

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Android release APK (standalone, no Metro required; signed with debug key)
          ANDROID_APK=$(find artifacts/android-release-apk -name "*.apk" -type f 2>/dev/null | head -1)
          if [ -n "$ANDROID_APK" ]; then
            cp "$ANDROID_APK" release-assets/SherpaOnnxExample-android-release.apk
            echo "[OK] Android APK: $ANDROID_APK"
          else
            echo "[WARN] Android APK not found"
          fi

          # SDK NPM tarball
          SDK_TGZ=$(find artifacts/sdk-package -name "*.tgz" -type f 2>/dev/null | head -1)
          if [ -n "$SDK_TGZ" ]; then
            SDK_NAME=$(basename "$SDK_TGZ")
            cp "$SDK_TGZ" "release-assets/$SDK_NAME"
            echo "[OK] SDK package: $SDK_TGZ"
          else
            echo "[WARN] SDK package (.tgz) not found"
          fi

          # iOS app bundle (from sdk-ios workflow)
          IOS_IPA=$(find artifacts/ios-app-bundle -name "*.ipa" -type f 2>/dev/null | head -1)
          if [ -n "$IOS_IPA" ]; then
            cp "$IOS_IPA" release-assets/SherpaOnnxExample-ios.ipa
            echo "[OK] iOS IPA: $IOS_IPA"
          else
            echo "[WARN] iOS IPA not found"
          fi

          echo ""
          echo "Release assets:"
          ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Release ${{ steps.tag.outputs.tag_name }}
          body: |
            ## Release ${{ steps.tag.outputs.tag_name }}

            ### Installation

            - **npm:** `npm install react-native-sherpa-onnx`
            - **yarn:** `yarn add react-native-sherpa-onnx`

            ### Artifacts

            | Artifact | Description |
            |----------|-------------|
            | `react-native-sherpa-onnx-*.tgz` | NPM package tarball (install via `yarn add <file>` or `npm install <file>`) |
            | `SherpaOnnxExample-android-release.apk` | Android example app (release build, debug key, no Metro) |
            | `SherpaOnnxExample-ios.ipa` | iOS example app (simulator build) |

            ### iOS Framework

            The iOS framework is automatically downloaded during `pod install`. No manual setup needed.
            For manual management: [Download Framework](https://github.com/XDcobra/react-native-sherpa-onnx/releases?q=framework)

            ---

            Built from commit: ${{ github.sha }}
          files: |
            release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
