name: SDK - Build Android example app

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'readme.md'
      - '**/README.md'
      - 'docs/**'
  workflow_dispatch:
  workflow_call:

# Only cancel in-progress runs for the same workflow+ref when running standalone.
# When called via workflow_call, the caller manages concurrency.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name != 'workflow_call' }}

jobs:
  # Lint runs only for standalone triggers (PR, push, dispatch).
  # When called via workflow_call (from sdk-release.yml), the caller runs lint centrally.
  lint:
    if: github.event_name != 'workflow_call'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Cache SherpaOnnx models
        uses: actions/cache@v4
        with:
          path: example/.model-cache
          key: ${{ runner.os }}-sherpa-models-${{ hashFiles('example/scripts/model-download-config.json', 'example/scripts/download-models.js') }}
          restore-keys: |
            ${{ runner.os }}-sherpa-models-

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  build-android:
    runs-on: ubuntu-latest
    # Run after lint when standalone; skip lint check when called via workflow_call (lint is skipped)
    needs: [lint]
    if: ${{ !cancelled() && (needs.lint.result == 'success' || needs.lint.result == 'skipped') }}
    timeout-minutes: 60

    env:
      JAVA_VERSION: '17'
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup
        uses: ./.github/actions/setup

      - name: Setup SherpaOnnx assets (headers and framework)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Setting up SherpaOnnx assets..."
          yarn setup-assets

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Set up Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r29
          add-to-path: true

      # ── FFmpeg prebuilts (cached across runs) ──────────────────────────
      - name: Get submodule versions
        id: submodules
        run: |
          echo "ffmpeg=$(git -C third_party/ffmpeg rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "shine=$(git -C third_party/shine rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Cache FFmpeg prebuilts
        uses: actions/cache@v4
        id: ffmpeg-cache
        with:
          path: |
            third_party/ffmpeg_prebuilt/android
            third_party/shine_prebuilt/android
          key: ffmpeg-android-prebuilt-${{ steps.submodules.outputs.ffmpeg }}-${{ steps.submodules.outputs.shine }}-${{ hashFiles('third_party/ffmpeg_prebuilt/build_ffmpeg.sh', 'third_party/shine_prebuilt/build_shine.sh') }}

      - name: Install FFmpeg build dependencies
        if: steps.ffmpeg-cache.outputs.cache-hit != 'true'
        run: sudo apt-get update && sudo apt-get install -y pkg-config libunistring-dev libaom-dev libdav1d-dev

      - name: Build libshine
        if: steps.ffmpeg-cache.outputs.cache-hit != 'true'
        run: |
          cd third_party/shine_prebuilt
          chmod +x build_shine.sh
          ./build_shine.sh
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Build FFmpeg (with libshine)
        if: steps.ffmpeg-cache.outputs.cache-hit != 'true'
        run: |
          cd third_party/ffmpeg_prebuilt
          chmod +x build_ffmpeg.sh
          ./build_ffmpeg.sh
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Copy FFmpeg prebuilts to jniLibs
        run: node third_party/ffmpeg_prebuilt/copy_prebuilts_to_sdk.js

      # ── Verification ───────────────────────────────────────────────────
      - name: Verify required files exist
        run: |
          echo "Verifying required files..."

          if [ ! -f "android/src/main/cpp/include/sherpa-onnx/c-api/c-api.h" ]; then
            echo "Error: Android header files not found at android/src/main/cpp/include/sherpa-onnx/c-api/c-api.h"
            exit 1
          fi
          echo "[OK] Header files found"

          if [ ! -f "android/src/main/cpp/CMakeLists.txt" ]; then
            echo "Error: CMakeLists.txt not found at android/src/main/cpp/CMakeLists.txt"
            exit 1
          fi
          echo "[OK] CMakeLists.txt found"

          if [ ! -f "android/build.gradle" ]; then
            echo "Error: android/build.gradle not found"
            exit 1
          fi
          echo "[OK] android/build.gradle found"

          # Verify FFmpeg prebuilts and jniLibs
          for abi in arm64-v8a armeabi-v7a x86 x86_64; do
            if [ ! -d "third_party/ffmpeg_prebuilt/android/${abi}/lib" ]; then
              echo "Error: FFmpeg prebuilt libs missing for ${abi}"
              exit 1
            fi
            if [ ! -f "android/src/main/jniLibs/${abi}/libavcodec.so" ]; then
              echo "Error: FFmpeg .so missing in jniLibs/${abi}/"
              exit 1
            fi
          done
          echo "[OK] FFmpeg prebuilts and jniLibs verified"

          if [ ! -f "example/android/build.gradle" ]; then
            echo "Error: example/android/build.gradle not found"
            exit 1
          fi
          echo "[OK] example/android/build.gradle found"

          if [ ! -f "example/android/app/build.gradle" ]; then
            echo "Error: example/android/app/build.gradle not found"
            exit 1
          fi
          echo "[OK] example/android/app/build.gradle found"

          echo ""
          echo "Header file structure:"
          find android/src/main/cpp/include -name "*.h" -type f | head -10 || echo "No header files found"

      - name: Make gradlew executable
        run: |
          cd example/android
          chmod +x gradlew
          chmod +x gradlew.bat

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            example/android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Android example app
        id: build-android
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          set -o pipefail
          echo "Building Android example app (NDK: $ANDROID_NDK_HOME)..."
          cd example/android

          ./gradlew assembleDebug \
            --stacktrace \
            --info \
            2>&1 | tee /tmp/build.full.log | tail -30
          GRADLE_EXIT=$?
          if [ "$GRADLE_EXIT" -ne 0 ]; then
            exit "$GRADLE_EXIT"
          fi
          echo "[OK] Android build completed successfully"

      - name: Debug CMake build failure
        if: ${{ failure() && steps.build-android.outcome == 'failure' }}
        working-directory: example/android
        run: |
          echo "=== Build failed. Dumping CMake debug info ==="

          echo ""
          echo "--- Generated Android-autolinking.cmake ---"
          AUTOLINK_CMAKE="app/build/generated/autolinking/src/main/jni/Android-autolinking.cmake"
          if [ -f "$AUTOLINK_CMAKE" ]; then
            cat "$AUTOLINK_CMAKE"
          else
            echo "File not found: $AUTOLINK_CMAKE"
          fi

          echo ""
          echo "--- Generated autolinking .cpp/.h files ---"
          find app/build/generated/autolinking -type f \( -name "*.cpp" -o -name "*.h" \) 2>/dev/null | while read f; do
            echo "=== $f ==="
            cat "$f"
          done

          echo ""
          echo "--- CMakeError.log (arm64-v8a) ---"
          CMAKE_ERR=$(find app/.cxx -name "CMakeError.log" -path "*/arm64-v8a/*" 2>/dev/null | head -1)
          if [ -n "$CMAKE_ERR" ] && [ -f "$CMAKE_ERR" ]; then
            cat "$CMAKE_ERR"
          else
            echo "No CMakeError.log found for arm64-v8a"
          fi

          echo ""
          echo "--- CMakeOutput.log (last 100 lines, arm64-v8a) ---"
          CMAKE_OUT=$(find app/.cxx -name "CMakeOutput.log" -path "*/arm64-v8a/*" 2>/dev/null | head -1)
          if [ -n "$CMAKE_OUT" ] && [ -f "$CMAKE_OUT" ]; then
            tail -100 "$CMAKE_OUT"
          else
            echo "No CMakeOutput.log found for arm64-v8a"
          fi

          echo ""
          echo "--- Library codegen directories ---"
          echo "react-native-sherpa-onnx codegen:"
          find . -path "*react-native-sherpa-onnx/build/generated/source/codegen*" -type f 2>/dev/null | head -20 || echo "  (none found)"
          echo ""
          echo "All codegen jni CMakeLists:"
          find . -path "*/codegen/jni/CMakeLists.txt" -type f 2>/dev/null | while read f; do
            echo "=== $f ==="
            cat "$f"
          done

          echo ""
          echo "--- Kotlin / Codegen errors (if any) ---"
          if [ -f /tmp/build.full.log ]; then
            grep -E "Unresolved reference|NativeSherpaOnnxSpec|compileDebugKotlin|compileReleaseKotlin|generateCodegenSpec|codegen" /tmp/build.full.log | head -30 || echo "  (none)"
          fi
          echo ""
          echo "--- Filtered errors from build log ---"
          if [ -f /tmp/build.full.log ]; then
            grep -E "CMake Error|FAILED|error:" /tmp/build.full.log | head -40 || echo "No error lines"
            echo ""
            echo "--- Last 30 lines of build log ---"
            tail -30 /tmp/build.full.log
          else
            echo "/tmp/build.full.log not found"
          fi

      - name: Verify build artifacts
        run: |
          echo "Verifying build artifacts..."

          APK_PATH="example/android/app/build/outputs/apk/debug/app-debug.apk"

          if [ -f "$APK_PATH" ]; then
            echo "[OK] APK found: $APK_PATH"
            
            APK_SIZE=$(stat -f%z "$APK_PATH" 2>/dev/null || stat -c%s "$APK_PATH")
            APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
            echo "  APK size: ${APK_SIZE_MB}MB"
            
            if command -v unzip &> /dev/null; then
              echo ""
              echo "Checking APK contents for native libraries:"
              unzip -l "$APK_PATH" | grep -E "lib/.*\.so" | head -10 || echo "No native libraries found in APK listing"
            fi
          else
            echo "[ERROR] APK not found at expected path: $APK_PATH"
            echo "Available files in build directory:"
            find example/android/app/build -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
            exit 1
          fi

      - name: Upload Android APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: example/android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7
          if-no-files-found: error
