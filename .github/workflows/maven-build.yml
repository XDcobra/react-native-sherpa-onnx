# Build Android AAR (artifact only; publishing handled by sdk-release.yml).
# Builds: libshine (shine_prebuilt), FFmpeg (ffmpeg_prebuilt, with libshine), libarchive (via CMake),
# then produces the react-native-sherpa-onnx Android library .aar.

name: Maven - Build AAR

on:
  pull_request:
    branches:
      - main
  push:
    branches: [main]
    paths:
      - 'android/**'
      - 'third_party/**'
      - '.github/workflows/maven-build.yml'
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name != 'workflow_call' }}

env:
  ANDROID_API: "24"
  NDK_VERSION: "29.0.14206865"

jobs:
  # Lint runs only for standalone triggers (PR, push, dispatch).
  # When called via workflow_call (from sdk-release.yml), the caller runs lint centrally.
  lint:
    if: github.event_name != 'workflow_call'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Cache SherpaOnnx models
        uses: actions/cache@v4
        with:
          path: example/.model-cache
          key: ${{ runner.os }}-sherpa-models-${{ hashFiles('example/scripts/model-download-config.json', 'example/scripts/download-models.js') }}
          restore-keys: |
            ${{ runner.os }}-sherpa-models-

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  build-aar:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    needs: [lint]
    if: ${{ !cancelled() && (needs.lint.result == 'success' || needs.lint.result == 'skipped') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install build deps (pkg-config, FFmpeg deps)
        run: sudo apt-get update && sudo apt-get install -y pkg-config libunistring-dev libaom-dev libdav1d-dev

      - name: Set up Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r29
          add-to-path: true

      - name: Get submodule versions (for sherpa-onnx cache key)
        id: submodules
        run: |
          echo "sherpa=$(git -C third_party/sherpa-onnx rev-parse HEAD 2>/dev/null || echo 'none')" >> "$GITHUB_OUTPUT"

      - name: Read VERSIONS (for QNN SDK)
        id: versions
        run: |
          set -a
          source third_party/onnxruntime_prebuilt/VERSIONS
          set +a
          echo "QNN_SDK_VERSION=$QNN_SDK_VERSION" >> "$GITHUB_OUTPUT"

      - name: Yarn install
        run: yarn install --frozen-lockfile
        env:
          CI: "true"

      - name: Build libshine
        run: |
          cd third_party/shine_prebuilt
          chmod +x build_shine.sh
          ./build_shine.sh
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Build FFmpeg (with libshine)
        run: |
          cd third_party/ffmpeg_prebuilt
          chmod +x build_ffmpeg.sh
          ./build_ffmpeg.sh
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Copy prebuilts to SDK jniLibs
        run: node third_party/ffmpeg_prebuilt/copy_prebuilts_to_sdk.js

      - name: Cache sherpa-onnx prebuilts
        uses: actions/cache@v4
        id: sherpa-cache
        with:
          path: third_party/sherpa-onnx-prebuilt/android
          key: sherpa-android-prebuilt-qnn-${{ steps.submodules.outputs.sherpa }}-${{ hashFiles('third_party/sherpa-onnx-prebuilt/build_sherpa_onnx.sh', 'third_party/onnxruntime_prebuilt/VERSIONS') }}

      - name: Download and extract QNN SDK
        if: steps.sherpa-cache.outputs.cache-hit != 'true'
        id: qnn
        run: |
          QNN_VER="${{ steps.versions.outputs.QNN_SDK_VERSION }}"
          QNN_URL="https://softwarecenter.qualcomm.com/api/download/software/sdks/Qualcomm_AI_Runtime_Community/All/${QNN_VER}/v${QNN_VER}.zip"
          mkdir -p qnn-sdk
          cd qnn-sdk
          echo "Downloading QNN SDK ${QNN_VER} from Qualcomm..."
          if ! curl -sSfL -o qnn-archive "$QNN_URL"; then
            echo "::error::QNN SDK download failed."
            exit 1
          fi
          unzip -q -o qnn-archive
          rm -f qnn-archive
          QNN_IFACE=$(find . -path '*/include/QNN/QnnInterface.h' -type f 2>/dev/null | head -1)
          if [ -z "$QNN_IFACE" ]; then
            echo "::error::QNN SDK archive must contain include/QNN/QnnInterface.h"
            exit 1
          fi
          QNN_REL=$(dirname "$(dirname "$(dirname "$QNN_IFACE")")")
          QNN_ROOT="$(cd "$QNN_REL" && pwd)"
          echo "root=$QNN_ROOT" >> "$GITHUB_OUTPUT"

      - name: Build sherpa-onnx (Android, all ABIs, with QNN)
        if: steps.sherpa-cache.outputs.cache-hit != 'true'
        run: |
          cd third_party/sherpa-onnx-prebuilt
          chmod +x build_sherpa_onnx.sh
          ./build_sherpa_onnx.sh --qnn
        env:
          ANDROID_NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          QNN_SDK_ROOT: ${{ steps.qnn.outputs.root }}

      - name: Copy sherpa-onnx prebuilts to jniLibs
        run: node third_party/sherpa-onnx-prebuilt/copy_prebuilts_to_sdk.js

      - name: Copy Gradle wrapper to root
        run: |
          cp example/android/gradlew .
          cp example/android/gradlew.bat .
          chmod +x gradlew
          cp -r example/android/gradle .

      - name: Build Android AAR
        run: ./gradlew :android:assembleRelease -PstandaloneAarBuild=true --no-daemon --console=plain

      - name: Prepare AAR artifact with checksums
        run: |
          mkdir -p build-artifact
          cp android/build/outputs/aar/*.aar build-artifact/ || true
          for f in build-artifact/*.aar; do
            if [ -f "$f" ]; then
              sha1sum "$f" | awk '{print $1}' > "$f.sha1"
              md5sum "$f" | awk '{print $1}' > "$f.md5"
            fi
          done

      - name: Upload AAR artifact (with checksums)
        uses: actions/upload-artifact@v4
        with:
          name: sherpa-onnx-android-aar
          path: build-artifact/**
          if-no-files-found: error
