# SDK Release Orchestrator
# Triggered by pushing a v* tag (e.g., v1.2.0).
# Runs lint centrally, then calls sub-workflows in parallel for:
#   - Android example app build (debug APK)
#   - NPM package tarball
#   - Android AAR (Maven artifact)
# Finally creates a GitHub Release with all artifacts and publishes the AAR to Maven.

name: SDK - Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  actions: read

jobs:
  # ──────────────────────────────────────────────────────────
  # 1. Central lint (runs once, sub-workflows skip their own)
  # ──────────────────────────────────────────────────────────
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  # ──────────────────────────────────────────────────────────
  # 2. Parallel builds via reusable workflows (workflow_call)
  #    Artifacts are shared within this workflow run.
  # ──────────────────────────────────────────────────────────

  build-android:
    needs: [lint]
    uses: ./.github/workflows/sdk-android.yml
    secrets: inherit

  build-sdk:
    needs: [lint]
    uses: ./.github/workflows/sdk-sdk.yml
    secrets: inherit

  build-aar:
    needs: [lint]
    uses: ./.github/workflows/maven-build.yml
    secrets: inherit

  # ──────────────────────────────────────────────────────────
  # 3. Publish AAR to Maven repository
  # ──────────────────────────────────────────────────────────
  publish-maven:
    runs-on: ubuntu-latest
    needs: [build-aar]
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version from tag
        id: vars
        run: |
          TAG=${GITHUB_REF##*/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag: $TAG -> Version: $VERSION"

      - name: Download AAR artifact
        uses: actions/download-artifact@v4
        with:
          name: sherpa-onnx-android-aar
          path: build-artifact

      - name: Verify AAR exists
        run: |
          echo "AAR artifacts:"
          ls -lh build-artifact/
          AAR=$(find build-artifact -name "*.aar" -type f | head -1)
          if [ -z "$AAR" ]; then
            echo "Error: No AAR file found in build-artifact/"
            exit 1
          fi
          echo "Found AAR: $AAR"

      - name: Checkout Maven repository
        uses: actions/checkout@v4
        with:
          repository: 'XDcobra/maven'
          path: maven-repo
          token: ${{ secrets.MAVEN_REPO_PAT }}

      - name: Ensure existing metadata checksums
        env:
          GROUP_PATH: com/xdcobra/sherpa/sherpa-onnx-react-native
        run: |
          set -e
          META="$GITHUB_WORKSPACE/maven-repo/${GROUP_PATH}/maven-metadata.xml"
          if [ -f "$META" ]; then
            sha1sum "$META" | awk '{print $1}' > "$META.sha1"
            md5sum "$META" | awk '{print $1}' > "$META.md5"
            echo "Generated checksums for existing metadata"
          else
            echo "No existing maven-metadata.xml"
          fi

      - name: Install Maven
        run: sudo apt-get update && sudo apt-get install -y maven

      - name: Deploy AAR to Maven repository
        env:
          VERSION: ${{ steps.vars.outputs.version }}
        run: |
          set -e
          AAR=$(find build-artifact -name "*.aar" -type f | head -1)

          mvn org.apache.maven.plugins:maven-deploy-plugin:3.1.4:deploy-file \
            -DgroupId=com.xdcobra.sherpa \
            -DartifactId=sherpa-onnx-react-native \
            -Dversion=${VERSION} \
            -Dpackaging=aar \
            -Dfile="${AAR}" \
            -DgeneratePom=true \
            -Durl="file://$GITHUB_WORKSPACE/maven-repo"

      - name: Copy AAR checksums to Maven repository
        env:
          GROUP_PATH: com/xdcobra/sherpa/sherpa-onnx-react-native
          VERSION: ${{ steps.vars.outputs.version }}
        run: |
          set -e
          ART_DIR="$GITHUB_WORKSPACE/maven-repo/${GROUP_PATH}/${VERSION}"
          mkdir -p "$ART_DIR"
          ART_NAME="sherpa-onnx-react-native-${VERSION}.aar"
          for ext in sha1 md5; do
            SRC="$GITHUB_WORKSPACE/build-artifact/${ART_NAME}.${ext}"
            if [ -f "$SRC" ]; then
              cp "$SRC" "$ART_DIR/$(basename "$SRC")"
            else
              echo "No precomputed checksum for ${ART_NAME}.${ext}; skipping"
            fi
          done

      - name: Commit and push to Maven repository
        run: |
          set -e
          cd maven-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit" >&2
            exit 1
          fi
          git commit -m "Publish sherpa-onnx-react-native:${{ steps.vars.outputs.version }}"
          git push origin HEAD:main

  # ──────────────────────────────────────────────────────────
  # 4. Create GitHub Release with all artifacts
  # ──────────────────────────────────────────────────────────
  create-release:
    runs-on: ubuntu-latest
    needs: [build-android, build-sdk, build-aar, publish-maven]
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag: $TAG_NAME, Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "All downloaded artifacts:"
          find artifacts -type f | sort

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Android debug APK
          ANDROID_APK=$(find artifacts/android-debug-apk -name "*.apk" -type f 2>/dev/null | head -1)
          if [ -n "$ANDROID_APK" ]; then
            cp "$ANDROID_APK" release-assets/SherpaOnnxExample-android-debug.apk
            echo "[OK] Android APK: $ANDROID_APK"
          else
            echo "[WARN] Android APK not found"
          fi

          # SDK NPM tarball
          SDK_TGZ=$(find artifacts/sdk-package -name "*.tgz" -type f 2>/dev/null | head -1)
          if [ -n "$SDK_TGZ" ]; then
            SDK_NAME=$(basename "$SDK_TGZ")
            cp "$SDK_TGZ" "release-assets/$SDK_NAME"
            echo "[OK] SDK package: $SDK_TGZ"
          else
            echo "[WARN] SDK package (.tgz) not found"
          fi

          # Android AAR (from Maven build)
          AAR_FILE=$(find artifacts/sherpa-onnx-android-aar -name "*.aar" -type f 2>/dev/null | head -1)
          if [ -n "$AAR_FILE" ]; then
            AAR_NAME="sherpa-onnx-react-native-${{ steps.tag.outputs.version }}.aar"
            cp "$AAR_FILE" "release-assets/$AAR_NAME"
            echo "[OK] AAR: $AAR_FILE -> $AAR_NAME"
          else
            echo "[WARN] AAR file not found"
          fi

          echo ""
          echo "Release assets:"
          ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Release ${{ steps.tag.outputs.tag_name }}
          body: |
            ## Release ${{ steps.tag.outputs.tag_name }}

            ### Installation

            - **npm:** `npm install react-native-sherpa-onnx`
            - **yarn:** `yarn add react-native-sherpa-onnx`

            ### Artifacts

            | Artifact | Description |
            |----------|-------------|
            | `react-native-sherpa-onnx-*.tgz` | NPM package tarball (install via `yarn add <file>` or `npm install <file>`) |
            | `sherpa-onnx-react-native-*.aar` | Android AAR library (also published to Maven) |
            | `SherpaOnnxExample-android-debug.apk` | Android example app (debug build) |

            ### Maven

            The AAR is published to the [Maven repository](https://github.com/XDcobra/maven):

            ```gradle
            repositories {
                maven { url 'https://xdcobra.github.io/maven' }
            }
            dependencies {
                implementation 'com.xdcobra.sherpa:sherpa-onnx-react-native:${{ steps.tag.outputs.version }}'
            }
            ```

            ### iOS Framework

            The iOS framework is automatically downloaded during `pod install`. No manual setup needed.
            For manual management: [Download Framework](https://github.com/XDcobra/react-native-sherpa-onnx/releases?q=framework)

            ---

            Built from commit: ${{ github.sha }}
          files: |
            release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
