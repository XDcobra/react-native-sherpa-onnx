name: SDK - Build iOS example app
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'readme.md'
      - '**/README.md'
      - 'docs/**'
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Cache SherpaOnnx models
        uses: actions/cache@v4
        with:
          path: example/.model-cache
          key: ${{ runner.os }}-sherpa-models-${{ hashFiles('example/scripts/model-download-config.json', 'example/scripts/download-models.js') }}
          restore-keys: |
            ${{ runner.os }}-sherpa-models-

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  build-ios:
    runs-on: macos-26
    needs: lint

    env:
      XCODE_VERSION: 26.2
      # Pass token so download-models.js can call GitHub API (higher rate limit, avoids 403)
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        
      - name: Setup
        uses: ./.github/actions/setup

      - name: Download iOS framework
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: yarn download-ios-framework

      - name: Use appropriate Xcode version
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Set up Ruby and Bundler
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '4.0'
          bundler: '4.0.3'

      - name: Install CocoaPods dependencies
        run: |
          set -e
          cd example
          bundle install

          echo "Running pod install (vendored_frameworks handles XCFramework linking automatically)..."
          echo ""

          # Run pod install and capture output. Use PIPESTATUS so the step fails if pod install fails (tee alone would hide exit code).
          bundle exec pod install --project-directory=ios 2>&1 | tee /tmp/pod_install.log
          if [ "${PIPESTATUS[0]}" -ne 0 ]; then
            echo "Error: pod install failed with exit code ${PIPESTATUS[0]}"
            exit "${PIPESTATUS[0]}"
          fi

          echo ""
          echo "=== Filtering SherpaOnnx messages from pod install ==="
          grep -E "\[SherpaOnnx\]" /tmp/pod_install.log || echo "No SherpaOnnx messages found in pod install output"

          # Verify workspace and Pods were created (fail fast so we don't run xcodebuild without Pods)
          if [ ! -f "ios/VoiceLabOfflineTools.xcworkspace/contents.xcworkspacedata" ]; then
            echo "Error: Xcode workspace not created"
            exit 1
          fi
          if [ ! -f "ios/Pods/Target Support Files/Pods-VoiceLabOfflineTools/Pods-VoiceLabOfflineTools.debug.xcconfig" ]; then
            echo "Error: Pods Target Support Files not found (pod install may have failed or been skipped)"
            ls -la ios/Pods 2>/dev/null || echo "ios/Pods directory missing"
            exit 1
          fi

          echo ""
          echo "[OK] CocoaPods dependencies installed"

      - name: Build example for iOS
        run: |
          set -o pipefail
          echo "Building iOS example app for simulator..."

          cd example

          if [ ! -f "ios/Pods/Target Support Files/Pods-VoiceLabOfflineTools/Pods-VoiceLabOfflineTools.debug.xcconfig" ]; then
            echo "Error: Pods not found; pod install may have failed in the previous step."
            exit 1
          fi

          # Build for simulator using -sdk flag (more reliable than -destination)
          # This builds for the current architecture of the Mac runner
          if ! xcodebuild \
            -workspace ios/VoiceLabOfflineTools.xcworkspace \
            -scheme VoiceLabOfflineTools \
            -configuration Debug \
            -sdk iphonesimulator \
            -arch arm64 \
            -derivedDataPath ios/build \
            CODE_SIGNING_ALLOWED=NO \
            > /tmp/build.full.log 2>&1; then
            BUILD_FAILED=1
          fi

          # Display filtered output (errors, warnings, important messages)
          echo "=== Filtered Build Output ==="
          grep -E "(: error:|: warning:|BUILD SUCCEEDED|BUILD FAILED|Undefined symbols|fatal error)" /tmp/build.full.log | head -100 || true

          if [ "${BUILD_FAILED:-0}" = "1" ]; then
            echo ""
            echo "=== Build failed. Full error analysis ==="
            
            # Show all lines containing "error:" with context
            echo ""
            echo "--- Compilation/Linker Errors ---"
            grep -B 2 -A 5 ": error:" /tmp/build.full.log | head -100 || echo "No 'error:' lines found"
            
            # Show fatal errors
            echo ""
            echo "--- Fatal Errors ---"
            grep -B 2 -A 5 "fatal error" /tmp/build.full.log | head -50 || echo "No fatal errors found"
            
            # Check for undefined symbols (linking)
            echo ""
            echo "--- Undefined Symbols ---"
            grep -B 2 -A 10 "Undefined symbols" /tmp/build.full.log | head -50 || echo "No undefined symbols"
            
            # Show the CompileC failure details
            echo ""
            echo "--- Failed Commands ---"
            grep -B 5 -A 2 "following build commands failed" /tmp/build.full.log | head -30 || true
            
            # Last part of log for context
            echo ""
            echo "--- Last 50 lines of build log ---"
            tail -50 /tmp/build.full.log
            exit 1
          fi

          echo "[OK] iOS build completed successfully"

      - name: Verify build artifacts
        run: |
          echo "Verifying build artifacts..."

          if [ -d "example/ios/build" ]; then
            echo "[OK] Build directory exists"
            
            # Check for the app
            APP_PATH=$(find example/ios/build -name "*.app" -type d | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "[OK] App bundle found: $APP_PATH"
            else
              echo "Warning: App bundle not found in build directory"
            fi
          else
            echo "Warning: Build directory not found"
          fi

      - name: Create iOS IPA file
        if: startsWith(github.ref, 'refs/tags/sdk-v')
        run: |
          echo "Creating iOS IPA file..."

          # Find the app bundle
          APP_PATH=$(find example/ios/build -name "*.app" -type d | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "Error: App bundle not found"
            exit 1
          fi

          echo "Found app bundle: $APP_PATH"

          # Create IPA structure
          IPA_DIR="example/ios/build/ipa"
          PAYLOAD_DIR="$IPA_DIR/Payload"

          mkdir -p "$PAYLOAD_DIR"

          # Copy app bundle to Payload directory
          cp -R "$APP_PATH" "$PAYLOAD_DIR/"

          # Create IPA file (ZIP archive)
          IPA_NAME="VoiceLabOfflineTools.ipa"
          IPA_PATH="$IPA_DIR/$IPA_NAME"

          cd "$IPA_DIR"
          zip -r "$IPA_NAME" Payload
          cd - > /dev/null

          if [ -f "$IPA_PATH" ]; then
            IPA_SIZE=$(stat -f%z "$IPA_PATH" 2>/dev/null || stat -c%s "$IPA_PATH")
            IPA_SIZE_MB=$((IPA_SIZE / 1024 / 1024))
            echo "[OK] IPA file created: $IPA_PATH (${IPA_SIZE_MB}MB)"
          else
            echo "Error: IPA file was not created at $IPA_PATH"
            echo "Checking for IPA files in build directory:"
            find example/ios/build -name "*.ipa" -type f || echo "No IPA files found"
            exit 1
          fi

      - name: Upload iOS IPA artifact
        if: startsWith(github.ref, 'refs/tags/sdk-v')
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-bundle
          path: example/ios/build/ipa/*.ipa
          retention-days: 7
          if-no-files-found: error
