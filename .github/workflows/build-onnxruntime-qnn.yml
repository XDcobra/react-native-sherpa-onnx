# Build ONNX Runtime for Android with QNN support and publish as GitHub Release.
# Release tag is read from third_party/onnxruntime_prebuilt/ANDROID_RELEASE_TAG (same pattern as FFmpeg/sherpa-onnx).
# VERSIONS is still used for ONNXRUNTIME_VERSION, QNN_SDK_VERSION and the build. Tag should match versions, e.g.:
#   ort-android-qnn-v<ONNXRUNTIME_VERSION>-qnn<QNN_SDK_VERSION>

name: Prebuilt - ONNX Runtime (Android + QNN)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'third_party/onnxruntime_prebuilt/**'
      - 'third_party/onnxruntime/**'
      - '.github/workflows/build-onnxruntime-qnn.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-ort-qnn:
    runs-on: ubuntu-latest
    # ONNX Runtime for 4 ABIs + QNN can exceed 2h; GitHub max for jobs is 360.
    timeout-minutes: 360
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Read ANDROID_RELEASE_TAG and VERSIONS
        id: versions
        run: |
          TAG_FILE=third_party/onnxruntime_prebuilt/ANDROID_RELEASE_TAG
          VERSIONS_FILE=third_party/onnxruntime_prebuilt/VERSIONS
          if [ ! -f "$TAG_FILE" ]; then
            echo "::error::Missing $TAG_FILE (add a line with the release tag, e.g. ort-android-qnn-v1.17.1-qnn2.43.1.260218)"
            exit 1
          fi
          RELEASE_TAG=$(grep -v '^#' "$TAG_FILE" | grep -v '^[[:space:]]*$' | head -1 | tr -d '\r\n')
          if [ -z "$RELEASE_TAG" ]; then
            echo "::error::Empty release tag in $TAG_FILE"
            exit 1
          fi
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          if [ ! -f "$VERSIONS_FILE" ]; then
            echo "::error::Missing $VERSIONS_FILE"
            exit 1
          fi
          set -a
          source "$VERSIONS_FILE"
          set +a
          echo "ONNXRUNTIME_VERSION=$ONNXRUNTIME_VERSION" >> $GITHUB_OUTPUT
          echo "QNN_SDK_VERSION=$QNN_SDK_VERSION" >> $GITHUB_OUTPUT
          echo "ort_commit=$(git -C third_party/onnxruntime rev-parse HEAD 2>/dev/null || echo 'none')" >> $GITHUB_OUTPUT
          echo "Release tag: $RELEASE_TAG"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Set up Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r29
          add-to-path: true

      - name: Cache QNN SDK
        uses: actions/cache@v4
        id: qnn-cache
        with:
          path: qnn-sdk
          key: qnn-sdk-${{ steps.versions.outputs.QNN_SDK_VERSION }}

      - name: Download and extract QNN SDK
        if: steps.qnn-cache.outputs.cache-hit != 'true'
        run: |
          QNN_VER="${{ steps.versions.outputs.QNN_SDK_VERSION }}"
          QNN_URL="https://softwarecenter.qualcomm.com/api/download/software/sdks/Qualcomm_AI_Runtime_Community/All/${QNN_VER}/v${QNN_VER}.zip"
          mkdir -p qnn-sdk
          cd qnn-sdk
          echo "Downloading QNN SDK ${QNN_VER} from Qualcomm..."
          if ! curl -sSfL -o qnn-archive "$QNN_URL"; then
            echo "::error::QNN SDK download failed."
            exit 1
          fi
          unzip -q -o qnn-archive
          rm -f qnn-archive

      - name: Get QNN SDK root
        id: qnn
        run: |
          cd qnn-sdk
          QNN_IFACE=$(find . -path '*/include/QNN/QnnInterface.h' -type f 2>/dev/null | head -1)
          if [ -z "$QNN_IFACE" ]; then
            echo "::error::QNN SDK must contain include/QNN/QnnInterface.h"
            find . -name "QnnInterface.h" 2>/dev/null || true
            exit 1
          fi
          QNN_REL=$(dirname "$(dirname "$(dirname "$QNN_IFACE")")")
          QNN_ROOT="$(cd "$QNN_REL" && pwd)"
          echo "root=$QNN_ROOT" >> "$GITHUB_OUTPUT"
          echo "QNN SDK root: $QNN_ROOT"

      - name: Cache ONNX Runtime build output
        uses: actions/cache@v4
        id: ort-cache
        with:
          path: third_party/onnxruntime_prebuilt/android
          key: ort-android-qnn-${{ steps.versions.outputs.ort_commit }}-${{ hashFiles('third_party/onnxruntime_prebuilt/build_onnxruntime.sh', 'third_party/onnxruntime_prebuilt/VERSIONS') }}

      - name: Build ONNX Runtime with QNN
        if: steps.ort-cache.outputs.cache-hit != 'true'
        run: |
          cd third_party/onnxruntime_prebuilt
          chmod +x build_onnxruntime.sh
          export ANDROID_NDK="${{ steps.setup-ndk.outputs.ndk-path }}"
          export ANDROID_NDK_HOME="${{ steps.setup-ndk.outputs.ndk-path }}"
          export ANDROID_NDK_ROOT="${{ steps.setup-ndk.outputs.ndk-path }}"
          export ANDROID_HOME="$ANDROID_HOME"
          ./build_onnxruntime.sh --qnn
        env:
          QNN_SDK_ROOT: ${{ steps.qnn.outputs.root }}

      - name: Package for sherpa-onnx layout
        run: |
          ORT_VER="${{ steps.versions.outputs.ONNXRUNTIME_VERSION }}"
          ANDROID_DIR=third_party/onnxruntime_prebuilt/android
          LAYOUT_DIR=ort-sherpa-layout
          mkdir -p "$LAYOUT_DIR/$ORT_VER/headers"
          for abi in arm64-v8a armeabi-v7a x86 x86_64; do
            mkdir -p "$LAYOUT_DIR/$ORT_VER/jni/$abi"
            cp -v "$ANDROID_DIR/$abi/lib/libonnxruntime.so" "$LAYOUT_DIR/$ORT_VER/jni/$abi/"
          done
          cp -R "$ANDROID_DIR/arm64-v8a/headers/"* "$LAYOUT_DIR/$ORT_VER/headers/"
          echo "Layout: $ORT_VER/jni/<abi>/libonnxruntime.so and $ORT_VER/headers/"

      - name: Create release zip
        run: |
          cd ort-sherpa-layout
          zip -r ../onnxruntime-android-qnn.zip .
          cd ..
          ls -la onnxruntime-android-qnn.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.versions.outputs.release_tag }}
          name: ONNX Runtime Android + QNN ${{ steps.versions.outputs.release_tag }}
          body: |
            Prebuilt ONNX Runtime for Android with QNN (Qualcomm NPU) support.
            Layout matches sherpa-onnx Android build scripts: `${{ steps.versions.outputs.ONNXRUNTIME_VERSION }}/jni/<abi>/libonnxruntime.so` and `${{ steps.versions.outputs.ONNXRUNTIME_VERSION }}/headers/`.
            Used automatically by `third_party/sherpa-onnx-prebuilt/build_sherpa_onnx.sh` when building sherpa-onnx for Android.
          files: onnxruntime-android-qnn.zip
          draft: false
          prerelease: false
          skip_duplicate: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ONNX Runtime (Android + QNN) build complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** [${{ steps.versions.outputs.release_tag }}](https://github.com/${{ github.repository }}/releases/tag/${{ steps.versions.outputs.release_tag }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Asset \`onnxruntime-android-qnn.zip\` contains \`${{ steps.versions.outputs.ONNXRUNTIME_VERSION }}/jni/<abi>/libonnxruntime.so\` and \`${{ steps.versions.outputs.ONNXRUNTIME_VERSION }}/headers/\` for arm64-v8a, armeabi-v7a, x86, x86_64." >> $GITHUB_STEP_SUMMARY
          echo "Sherpa-onnx Android build uses this release automatically when \`build_sherpa_onnx.sh\` runs." >> $GITHUB_STEP_SUMMARY
