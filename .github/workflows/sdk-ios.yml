name: SDK - Build iOS example app
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'readme.md'
      - '**/README.md'
      - 'docs/**'
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Cache SherpaOnnx models
        uses: actions/cache@v4
        with:
          path: example/.model-cache
          key: ${{ runner.os }}-sherpa-models-${{ hashFiles('example/scripts/model-download-config.json', 'example/scripts/download-models.js') }}
          restore-keys: |
            ${{ runner.os }}-sherpa-models-

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  build-ios:
    runs-on: macos-26
    needs: lint

    env:
      XCODE_VERSION: 26.2
      # Pass token so download-models.js can call GitHub API (higher rate limit, avoids 403)
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        
      - name: Setup
        uses: ./.github/actions/setup

      - name: Use appropriate Xcode version
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Set up Ruby and Bundler
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '4.0'
          bundler: '4.0.3'

      - name: Check ios/Frameworks before any download (no cache used)
        run: |
          # This workflow does NOT use actions/cache for ios/Frameworks, so no stale/incomplete cache is restored.
          echo "=== ios/Frameworks state before download (this workflow does not cache ios/Frameworks) ==="
          if [ -d "ios/Frameworks" ]; then
            ls -la ios/Frameworks
            [ -d "ios/Frameworks/sherpa_onnx.xcframework" ] && find ios/Frameworks/sherpa_onnx.xcframework -maxdepth 3 -type d | head -20
          else
            echo "ios/Frameworks does not exist yet"
          fi

      - name: Download iOS framework (early â€“ same as yarn download-ios-framework)
        env:
          SHERPA_ONNX_PROJECT_ROOT: ${{ github.workspace }}
        run: |
          echo "Running yarn download-ios-framework from repo root..."
          yarn download-ios-framework
          echo "Download step finished (exit code: $?)"

      - name: Verify iOS framework and headers after download
        run: |
          echo "=== Verifying framework and required header right after download ==="
          HEADER="${{ github.workspace }}/ios/Frameworks/sherpa_onnx.xcframework/ios-arm64_x86_64-simulator/Headers/sherpa-onnx/c-api/cxx-api.h"
          if [ -f "$HEADER" ]; then
            echo "[OK] Header present: $HEADER"
            ls -la "$(dirname "$HEADER")"
          else
            echo "ERROR: Header missing after download: $HEADER"
            echo "--- Contents of ${{ github.workspace }}/ios/Frameworks ---"
            ls -la "${{ github.workspace }}/ios/Frameworks" 2>/dev/null || true
            find "${{ github.workspace }}/ios/Frameworks" -maxdepth 4 2>/dev/null | head -60
            exit 1
          fi

      - name: Build example for iOS
        env:
          # So prepare_command in SherpaOnnx.podspec downloads framework to workspace/ios/Frameworks (not elsewhere)
          SHERPA_ONNX_PROJECT_ROOT: ${{ github.workspace }}
        run: |
          set -o pipefail
          echo "Building iOS example app via React Native CLI (pod install runs automatically)..."
          BUILD_FAILED=0

          cd example
          bundle install

          # Run pod install explicitly with bundle so we use the same CocoaPods and get clear errors
          # (React Native CLI also runs it; doing it first avoids opaque "Something went wrong" messages).
          echo "Running bundle exec pod install..."
          (cd ios && SHERPA_ONNX_PROJECT_ROOT="$SHERPA_ONNX_PROJECT_ROOT" bundle exec pod install) || { echo "pod install failed; see above for errors"; exit 1; }

          # Verify SherpaOnnx framework and headers exist where the pod expects them (fail early with clear diagnostics)
          echo ""
          echo "=== Verifying SherpaOnnx framework and required headers ==="
          REPO_ROOT="$SHERPA_ONNX_PROJECT_ROOT"
          HEADER_PATH="$REPO_ROOT/ios/Frameworks/sherpa_onnx.xcframework/ios-arm64_x86_64-simulator/Headers/sherpa-onnx/c-api/cxx-api.h"
          if [ -f "$HEADER_PATH" ]; then
            echo "[OK] Required header found: $HEADER_PATH"
          else
            echo "ERROR: Required header NOT found: $HEADER_PATH"
            echo ""
            echo "--- Contents of $REPO_ROOT/ios/Frameworks ---"
            ls -la "$REPO_ROOT/ios/Frameworks" 2>/dev/null || echo "(directory missing or unreadable)"
            if [ -d "$REPO_ROOT/ios/Frameworks" ]; then
              echo ""
              echo "--- Recursive listing (first 80 lines) ---"
              find "$REPO_ROOT/ios/Frameworks" -maxdepth 4 2>/dev/null | head -80
            fi
            echo ""
            echo "--- If present: example node_modules react-native-sherpa-onnx ios/Frameworks ---"
            for dir in example/node_modules/react-native-sherpa-onnx/ios/Frameworks node_modules/react-native-sherpa-onnx/ios/Frameworks; do
              if [ -d "$REPO_ROOT/$dir" ]; then
                echo "  $dir:"
                ls -la "$REPO_ROOT/$dir" 2>/dev/null | head -15
              fi
            done
            exit 1
          fi

          # Use React Native CLI instead of calling pod install + xcodebuild directly (avoids deprecation warning).
          # Build for simulator with a fixed output path for artifacts.
          yarn build:ios \
            --mode Debug \
            --buildFolder ios/build \
            2>&1 | tee /tmp/build.full.log
          BUILD_EXIT=${PIPESTATUS[0]}
          if [ "$BUILD_EXIT" -ne 0 ]; then BUILD_FAILED=1; fi

          # Display filtered output (errors, warnings, important messages)
          echo ""
          echo "=== Filtered Build Output ==="
          grep -E "(: error:|: warning:|BUILD SUCCEEDED|BUILD FAILED|Undefined symbols|fatal error)" /tmp/build.full.log | head -100 || true

          if [ "${BUILD_FAILED:-0}" = "1" ]; then
            echo ""
            echo "=== Build failed. Full error analysis ==="
            echo ""
            echo "--- Compilation/Linker Errors ---"
            grep -B 2 -A 5 ": error:" /tmp/build.full.log | head -100 || echo "No 'error:' lines found"
            echo ""
            echo "--- Fatal Errors ---"
            grep -B 2 -A 5 "fatal error" /tmp/build.full.log | head -50 || echo "No fatal errors found"
            echo ""
            echo "--- Undefined Symbols ---"
            grep -B 2 -A 10 "Undefined symbols" /tmp/build.full.log | head -50 || echo "No undefined symbols"
            echo ""
            echo "--- Failed Commands ---"
            grep -B 5 -A 2 "following build commands failed" /tmp/build.full.log | head -30 || true
            echo ""
            echo "--- Last 50 lines of build log ---"
            tail -50 /tmp/build.full.log
            exit 1
          fi

          echo "[OK] iOS build completed successfully"

      - name: Verify build artifacts
        run: |
          echo "Verifying build artifacts..."

          if [ -d "example/ios/build" ]; then
            echo "[OK] Build directory exists"
            
            # Check for the app
            APP_PATH=$(find example/ios/build -name "*.app" -type d | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "[OK] App bundle found: $APP_PATH"
            else
              echo "Warning: App bundle not found in build directory"
            fi
          else
            echo "Warning: Build directory not found"
          fi

      - name: Create iOS IPA file
        if: startsWith(github.ref, 'refs/tags/sdk-v')
        run: |
          echo "Creating iOS IPA file..."

          # Find the app bundle
          APP_PATH=$(find example/ios/build -name "*.app" -type d | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "Error: App bundle not found"
            exit 1
          fi

          echo "Found app bundle: $APP_PATH"

          # Create IPA structure
          IPA_DIR="example/ios/build/ipa"
          PAYLOAD_DIR="$IPA_DIR/Payload"

          mkdir -p "$PAYLOAD_DIR"

          # Copy app bundle to Payload directory
          cp -R "$APP_PATH" "$PAYLOAD_DIR/"

          # Create IPA file (ZIP archive)
          IPA_NAME="VoiceLabOfflineTools.ipa"
          IPA_PATH="$IPA_DIR/$IPA_NAME"

          cd "$IPA_DIR"
          zip -r "$IPA_NAME" Payload
          cd - > /dev/null

          if [ -f "$IPA_PATH" ]; then
            IPA_SIZE=$(stat -f%z "$IPA_PATH" 2>/dev/null || stat -c%s "$IPA_PATH")
            IPA_SIZE_MB=$((IPA_SIZE / 1024 / 1024))
            echo "[OK] IPA file created: $IPA_PATH (${IPA_SIZE_MB}MB)"
          else
            echo "Error: IPA file was not created at $IPA_PATH"
            echo "Checking for IPA files in build directory:"
            find example/ios/build -name "*.ipa" -type f || echo "No IPA files found"
            exit 1
          fi

      - name: Upload iOS IPA artifact
        if: startsWith(github.ref, 'refs/tags/sdk-v')
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-bundle
          path: example/ios/build/ipa/*.ipa
          retention-days: 7
          if-no-files-found: error
