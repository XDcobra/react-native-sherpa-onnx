# Build Android AAR for Maven release (artifact only; no publish).
# Builds: libshine (shine_prebuilt), FFmpeg (ffmpeg_prebuilt, with libshine), libarchive (via CMake),
# then produces the react-native-sherpa-onnx Android library .aar.

name: Maven - Build AAR

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      maven_version:
        description: "Optional: tag string in format 'maven-vX.Y.Z' to release (must include 'maven-v')"
        required: false
  push:
    branches: [main]
    tags:
      - 'maven-v*'
    paths:
      - 'android/**'
      - 'third_party/**'
      - '.github/workflows/maven-build.yml'

env:
  ANDROID_API: "24"
  NDK_VERSION: "29.0.14206865"

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Cache SherpaOnnx models
        uses: actions/cache@v4
        with:
          path: example/.model-cache
          key: ${{ runner.os }}-sherpa-models-${{ hashFiles('example/scripts/model-download-config.json', 'example/scripts/download-models.js') }}
          restore-keys: |
            ${{ runner.os }}-sherpa-models-

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  build-aar:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install build deps (pkg-config, FFmpeg deps)
        run: sudo apt-get update && sudo apt-get install -y pkg-config libunistring-dev libaom-dev libdav1d-dev

      - name: Set up Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r29
          add-to-path: true

      - name: Yarn install
        run: yarn install --frozen-lockfile
        env:
          # Headers are copied from sherpa-onnx submodule by setup-assets/copy-headers
          CI: "true"

      - name: Build libshine
        run: |
          cd third_party/shine_prebuilt
          chmod +x build_shine.sh
          ./build_shine.sh
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Build FFmpeg (with libshine)
        run: |
          cd third_party/ffmpeg_prebuilt
          chmod +x build_ffmpeg.sh
          ./build_ffmpeg.sh
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Copy prebuilts to SDK jniLibs
        run: node third_party/ffmpeg_prebuilt/copy_prebuilts_to_sdk.js

      - name: Copy Gradle wrapper to root
        run: |
          cp example/android/gradlew .
          cp example/android/gradlew.bat .
          chmod +x gradlew
          cp -r example/android/gradle .

      - name: Build Android AAR
        run: ./gradlew :android:assembleRelease -PstandaloneAarBuild=true --no-daemon --console=plain

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: sherpa-onnx-android-aar
          path: android/build/outputs/aar/*.aar

  publish-maven:
    runs-on: ubuntu-latest
    needs: build-aar
    permissions:
      contents: write
    if: |
      github.event_name == 'push' && startsWith(github.ref, 'refs/tags/maven-v') ||
      github.event_name == 'workflow_dispatch' && github.event.inputs.maven_version != ''
    steps:
      - name: Checkout source repo (for creating tag if needed)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Determine tag and version
        id: vars
        run: |
          if [ "$GITHUB_EVENT_NAME" = "push" ]; then
            TAG=${GITHUB_REF##*/}
          else
            TAG="${{ github.event.inputs.maven_version }}"
          fi

          if [ -z "$TAG" ]; then
            echo "No tag provided" >&2
            exit 1
          fi

          RAW_VERSION=${TAG#maven-}
          VERSION=${RAW_VERSION#v}

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create tag if dispatched and missing
        if: github.event_name == 'workflow_dispatch'
        run: |
          TAG=${{ steps.vars.outputs.tag }}
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "Tag $TAG already exists"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "$TAG"
            git push origin "$TAG"
            echo "Created and pushed tag $TAG"
          fi

      - name: Download build artifact (AAR)
        uses: actions/download-artifact@v4
        with:
          name: sherpa-onnx-android-aar
          path: build-artifact

      - name: Checkout target Maven repo
        uses: actions/checkout@v4
        with:
          repository: 'XDcobra/maven'
          path: maven-repo
          token: ${{ secrets.MAVEN_REPO_PAT }}

      - name: Ensure existing metadata checksums (pre-deploy)
        env:
          GROUP_PATH: com/xdcobra/sherpa/sherpa-onnx-react-native
        run: |
          set -e
          META="$GITHUB_WORKSPACE/maven-repo/${GROUP_PATH}/maven-metadata.xml"
          if [ -f "$META" ]; then
            sha1sum "$META" | awk '{print $1}' > "$META.sha1"
            md5sum "$META" | awk '{print $1}' > "$META.md5"
            echo "Generated checksums for existing metadata: $META"
          else
            echo "No existing maven-metadata.xml to checksum"
          fi

      - name: Install Maven
        run: sudo apt-get update && sudo apt-get install -y maven

      - name: Deploy artifact into checked-out Maven repo (local file URL)
        env:
          VERSION: ${{ steps.vars.outputs.version }}
        run: |
          set -e
          AAR=$(ls build-artifact/*.aar | head -n1)
          if [ -z "$AAR" ]; then
            echo "AAR not found" >&2
            exit 1
          fi

          # deploy-file to local file-based repo (will create proper pom and metadata)
          mvn org.apache.maven.plugins:maven-deploy-plugin:3.0.0-M1:deploy-file \
            -DgroupId=com.xdcobra.sherpa \
            -DartifactId=sherpa-onnx-react-native \
            -Dversion=${VERSION} \
            -Dpackaging=aar \
            -Dfile="${AAR}" \
            -DgeneratePom=true \
            -Durl="file://$GITHUB_WORKSPACE/maven-repo"

      - name: Generate checksum files for deployed artifacts and metadata
        env:
          GROUP_PATH: com/xdcobra/sherpa/sherpa-onnx-react-native
          VERSION: ${{ steps.vars.outputs.version }}
        run: |
          set -e
          cd maven-repo
          # target artifact directory and metadata
          ART_DIR="${GROUP_PATH}/${VERSION}"

          # create checksums for the AAR and POM in the version dir
          find "$ART_DIR" -type f \( -name '*.aar' -o -name '*.pom' \) -print0 | while IFS= read -r -d '' f; do
            if [ ! -f "$f.sha1" ]; then
              sha1sum "$f" | awk '{print $1}' > "$f.sha1"
            fi
            if [ ! -f "$f.md5" ]; then
              md5sum "$f" | awk '{print $1}' > "$f.md5"
            fi
          done

          # also ensure checksums exist for group-level maven-metadata.xml
          META="${GROUP_PATH}/maven-metadata.xml"
          if [ -f "$META" ]; then
            if [ ! -f "$META.sha1" ]; then
              sha1sum "$META" | awk '{print $1}' > "$META.sha1"
            fi
            if [ ! -f "$META.md5" ]; then
              md5sum "$META" | awk '{print $1}' > "$META.md5"
            fi
          fi

      - name: Commit and push to Maven repo
        env:
          MAVEN_REPO_PAT: ${{ secrets.MAVEN_REPO_PAT }}
        run: |
          set -e
          cd maven-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          # fail if there are no staged changes (treat as error so job aborts)
          if git diff --cached --quiet; then
            echo "No changes to commit" >&2
            exit 1
          fi

          git commit -m "Publish sherpa-onnx-react-native:${{ steps.vars.outputs.version }} to GitHub Pages Maven repo"
          git push origin HEAD:main
