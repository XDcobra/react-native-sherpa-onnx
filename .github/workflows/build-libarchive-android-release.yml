# Build libarchive for Android and publish as GitHub Release and to Maven.
# Release tag is read from third_party/libarchive_prebuilt/ANDROID_RELEASE_TAG.
# AAR is published to GitHub Pages Maven as com.xdcobra.sherpa:libarchive when MAVEN_REPO_PAT is set.
#
# When to run manually (Actions → Prebuilt - libarchive (Android) Release → Run workflow):
# 1. After updating third_party/libarchive_prebuilt/ANDROID_RELEASE_TAG or libarchive submodule.
# 2. When you want to publish a new libarchive Android release (zip + AAR, optional Maven).
#
name: Prebuilt - libarchive (Android) Release

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-libarchive-android:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Read release tag
        id: tag
        run: |
          TAG_FILE=third_party/libarchive_prebuilt/ANDROID_RELEASE_TAG
          if [ ! -f "$TAG_FILE" ]; then
            echo "::error::Missing $TAG_FILE (add a line with the release tag, e.g. libarchive-android-v3.8.5)"
            exit 1
          fi
          RELEASE_TAG=$(grep -v '^#' "$TAG_FILE" | grep -v '^[[:space:]]*$' | head -1 | tr -d '\r\n')
          if [ -z "$RELEASE_TAG" ]; then
            echo "::error::Empty release tag in $TAG_FILE"
            exit 1
          fi
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          MAVEN_VERSION=$(echo "$RELEASE_TAG" | sed 's/^libarchive-android-v//')
          echo "maven_version=$MAVEN_VERSION" >> $GITHUB_OUTPUT
          echo "Using release tag: $RELEASE_TAG (Maven version: $MAVEN_VERSION)"

      - name: Set up Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r29
          add-to-path: true

      - name: Get libarchive submodule version
        id: submodules
        run: |
          echo "libarchive=$(git -C third_party/libarchive rev-parse HEAD 2>/dev/null || echo 'none')" >> "$GITHUB_OUTPUT"

      - name: Cache libarchive prebuilts
        uses: actions/cache@v4
        id: libarchive-cache
        with:
          path: third_party/libarchive_prebuilt/android
          key: libarchive-android-prebuilt-${{ steps.submodules.outputs.libarchive }}-${{ hashFiles('third_party/libarchive_prebuilt/build_libarchive_android.sh') }}

      - name: Build libarchive
        if: steps.libarchive-cache.outputs.cache-hit != 'true'
        run: |
          cd third_party/libarchive_prebuilt
          chmod +x build_libarchive_android.sh
          ./build_libarchive_android.sh
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Package jniLibs layout
        run: |
          LAYOUT=libarchive-android-layout
          rm -rf "$LAYOUT"
          mkdir -p "$LAYOUT"
          ABIS="arm64-v8a armeabi-v7a x86 x86_64"
          for abi in $ABIS; do
            mkdir -p "$LAYOUT/$abi"
            SRC="third_party/libarchive_prebuilt/android/$abi/lib"
            if [ -d "$SRC" ]; then
              cp "$SRC"/*.so "$LAYOUT/$abi/" 2>/dev/null || true
            fi
          done
          if [ -d "third_party/libarchive_prebuilt/android/include" ]; then
            mkdir -p "$LAYOUT/include"
            cp -R third_party/libarchive_prebuilt/android/include/* "$LAYOUT/include/"
          fi
          echo "Layout contents:"
          find "$LAYOUT" -type f \( -name '*.so' -o -name '*.h' \) | head -50

      - name: Upload layout as artifact
        uses: actions/upload-artifact@v4
        with:
          name: libarchive-android-layout-${{ steps.tag.outputs.maven_version }}
          path: libarchive-android-layout/
          retention-days: 7

      - name: Create release zip
        run: |
          cd libarchive-android-layout
          zip -r ../libarchive-android.zip .
          cd ..
          ls -la libarchive-android.zip

      - name: Create libarchive AAR
        run: |
          chmod +x third_party/libarchive_prebuilt/create_libarchive_aar.sh
          VER="${{ steps.tag.outputs.maven_version }}"
          third_party/libarchive_prebuilt/create_libarchive_aar.sh libarchive-android-layout "$VER" "libarchive-${VER}.aar"
          ls -la "libarchive-${VER}.aar"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: libarchive Android ${{ steps.tag.outputs.release_tag }}
          body: |
            Prebuilt libarchive for Android (arm64-v8a, armeabi-v7a, x86, x86_64).
            - **libarchive-android.zip** – Layout: `arm64-v8a/`, `armeabi-v7a/`, `x86/`, `x86_64/` (libarchive.so) and `include/` (headers).
            - **libarchive-${{ steps.tag.outputs.maven_version }}.aar** – Android library (native libs + headers). Also on Maven as `com.xdcobra.sherpa:libarchive`.

            **Maven:** The AAR is published to [GitHub Pages Maven](https://xdcobra.github.io/maven/) as `com.xdcobra.sherpa:libarchive` when MAVEN_REPO_PAT is set.
          files: |
            libarchive-android.zip
            libarchive-${{ steps.tag.outputs.maven_version }}.aar
          draft: false
          prerelease: false
          skip_duplicate: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish libarchive AAR to GitHub Pages Maven (XDcobra/maven)
        if: success()
        env:
          MAVEN_REPO_PAT: ${{ secrets.MAVEN_REPO_PAT }}
          MAVEN_VERSION: ${{ steps.tag.outputs.maven_version }}
          AAR_SRC: libarchive-${{ steps.tag.outputs.maven_version }}.aar
        run: |
          if [ -z "${MAVEN_REPO_PAT}" ]; then
            echo "MAVEN_REPO_PAT not set, skipping Maven publish."
            exit 0
          fi
          chmod +x third_party/libarchive_prebuilt/publish-maven/publish-to-github-pages.sh
          third_party/libarchive_prebuilt/publish-maven/publish-to-github-pages.sh

      - name: Summary
        run: |
          echo "## libarchive Android release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** [${{ steps.tag.outputs.release_tag }}](https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.release_tag }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Asset | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`libarchive-android.zip\` | Layout: \`arm64-v8a/\`, \`armeabi-v7a/\`, \`x86/\`, \`x86_64/\` (libarchive.so) and \`include/\` (headers). |" >> $GITHUB_STEP_SUMMARY
          echo "| \`libarchive-${{ steps.tag.outputs.maven_version }}.aar\` | Android library (native libs + headers). Published to Maven as \`com.xdcobra.sherpa:libarchive\` when MAVEN_REPO_PAT is set. |" >> $GITHUB_STEP_SUMMARY
