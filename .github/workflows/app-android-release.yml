name: App - Release Android

on:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-android-release:
    runs-on: ubuntu-latest

    env:
      JAVA_VERSION: '17'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Setup SherpaOnnx assets (headers and framework)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Setting up SherpaOnnx assets..."
          yarn setup-assets

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Prepare release keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -z "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "Error: ANDROID_KEYSTORE_BASE64 is not set"
            exit 1
          fi

          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > example/android/app/release.keystore

      - name: Derive version
        id: version
        run: |
          set -euo pipefail

          VERSION_NAME_INPUT="${{ inputs.version_name }}"
          BUILD_NUMBER_INPUT="${{ inputs.build_number }}"

          if [ -n "$VERSION_NAME_INPUT" ]; then
            VERSION_NAME="$VERSION_NAME_INPUT"
          else
            if [ "${GITHUB_REF_TYPE:-}" = "tag" ] && [[ "${GITHUB_REF_NAME:-}" =~ ^app-v(.+)$ ]]; then
              VERSION_NAME="${BASH_REMATCH[1]}"
            else
              VERSION_NAME=$(node -p "require('./example/package.json').version")
            fi
          fi

          if [ -n "$BUILD_NUMBER_INPUT" ]; then
            BUILD_NUMBER="$BUILD_NUMBER_INPUT"
          else
            BUILD_NUMBER=$(git rev-list --count HEAD)
          fi

          echo "version_name=$VERSION_NAME" >> "$GITHUB_OUTPUT"
          echo "build_number=$BUILD_NUMBER" >> "$GITHUB_OUTPUT"
          echo "Resolved version_name=$VERSION_NAME build_number=$BUILD_NUMBER"

      - name: Build Android release AAB
        env:
          ORG_GRADLE_PROJECT_RELEASE_STORE_FILE: ${{ github.workspace }}/example/android/app/release.keystore
          ORG_GRADLE_PROJECT_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ORG_GRADLE_PROJECT_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ORG_GRADLE_PROJECT_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ORG_GRADLE_PROJECT_VERSION_CODE: ${{ steps.version.outputs.build_number }}
          ORG_GRADLE_PROJECT_VERSION_NAME: ${{ steps.version.outputs.version_name }}
          ORG_GRADLE_PROJECT_ADMOB_APP_ID_ANDROID: ${{ secrets.ADMOB_APP_ID_ANDROID }}
          ORG_GRADLE_PROJECT_ADMOB_BANNER_ID_ANDROID: ${{ secrets.ADMOB_BANNER_ID_ANDROID }}
        run: |
          set -o pipefail
          echo "Building Android release AAB..."

          cd example/android

          ./gradlew clean

          if ! ./gradlew bundleRelease \
            --stacktrace \
            --info \
            > /tmp/build.full.log 2>&1; then
            BUILD_FAILED=1
          fi

          echo "=== Filtered Build Output ==="
          grep -E "(FAILED|ERROR|error:|warning:|BUILD SUCCEEDED|BUILD FAILED|FAILURE|Exception)" /tmp/build.full.log | head -100 || true

          if [ "${BUILD_FAILED:-0}" = "1" ]; then
            echo ""
            echo "=== Build failed. Full error analysis ==="

            echo ""
            echo "--- Compilation/Linker Errors ---"
            grep -B 2 -A 5 -i "error:" /tmp/build.full.log | head -100 || echo "No 'error:' lines found"

            echo ""
            echo "--- Fatal Errors ---"
            grep -B 2 -A 5 -i "fatal" /tmp/build.full.log | head -50 || echo "No fatal errors found"

            echo ""
            echo "--- Exceptions ---"
            grep -B 2 -A 10 "Exception" /tmp/build.full.log | head -50 || echo "No exceptions found"

            echo ""
            echo "--- CMake Errors ---"
            grep -B 2 -A 5 -i "cmake" /tmp/build.full.log | grep -i "error\|fail" | head -30 || echo "No CMake errors found"

            echo ""
            echo "--- Failed Tasks ---"
            grep -B 5 -A 2 "FAILED" /tmp/build.full.log | head -30 || true

            echo ""
            echo "--- Last 50 lines of build log ---"
            tail -50 /tmp/build.full.log
            exit 1
          fi

          echo "[OK] Android release build completed successfully"

      - name: Verify release AAB artifact
        run: |
          echo "Verifying AAB artifact..."

          AAB_PATH="example/android/app/build/outputs/bundle/release/app-release.aab"

          if [ -f "$AAB_PATH" ]; then
            echo "[OK] AAB found: $AAB_PATH"

            AAB_SIZE=$(stat -f%z "$AAB_PATH" 2>/dev/null || stat -c%s "$AAB_PATH")
            AAB_SIZE_MB=$((AAB_SIZE / 1024 / 1024))
            echo "  AAB size: ${AAB_SIZE_MB}MB"
          else
            echo "[ERROR] AAB not found at expected path: $AAB_PATH"
            echo "Available bundle outputs:"
            find example/android/app/build/outputs -name "*.aab" -type f 2>/dev/null || echo "No AAB files found"
            exit 1
          fi

      - name: Upload Android AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release-aab
          path: example/android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 7
          if-no-files-found: error

      - name: Set up Ruby (Fastlane)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: example/android

      - name: Prepare Fastlane JSON key
        env:
          FASTLANE_JSON_KEY: ${{ secrets.FASTLANE_JSON_KEY }}
        run: |
          if [ -z "$FASTLANE_JSON_KEY" ]; then
            echo "Error: FASTLANE_JSON_KEY is not set"
            exit 1
          fi

          mkdir -p example/android/fastlane
          printf '%s' "$FASTLANE_JSON_KEY" > example/android/fastlane/fastlane.json
          chmod 600 example/android/fastlane/fastlane.json

      - name: Upload to Play Store (Closed Testing)
        run: |
          cd example/android
          bundle exec fastlane closed_testing
