// Prebuilt versions (sherpa-onnx, FFmpeg, libarchive) from prebuilt-versions.gradle.
// Resolution: env → ANDROID_RELEASE_TAG files → project property → default.
apply from: file("${project.projectDir}/prebuilt-versions.gradle")

// Used by dependencies below and by prebuilt-download.gradle (extractSherpaOnnxClasses, downloadNativeLibsIfNeeded).
def sherpaOnnxClassesDir = file("${buildDir}/sherpa-onnx-classes")

buildscript {
  ext.SherpaOnnx = [
    kotlinVersion: "2.0.21",
    minSdkVersion: 24,
    compileSdkVersion: 36,
    targetSdkVersion: 36
  ]

  ext.getExtOrDefault = { prop ->
    if (rootProject.ext.has(prop)) {
      return rootProject.ext.get(prop)
    }

    return SherpaOnnx[prop]
  }

  repositories {
    google()
    mavenCentral()
    maven { url 'https://plugins.gradle.org/m2/' }
  }

  dependencies {
    classpath "com.android.tools.build:gradle:8.7.2"
    // noinspection DifferentKotlinGradleVersion
    classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:${getExtOrDefault('kotlinVersion')}"
    // Node Gradle plugin for running node/npx reliably from Gradle
    classpath "com.github.node-gradle:gradle-node-plugin:7.1.0"
  }
}


apply plugin: "com.android.library"
apply plugin: "kotlin-android"

// Standalone AAR build: set in root build.gradle (ext.standaloneAarBuild = true) or via -PstandaloneAarBuild=true
def isStandaloneAarBuild = rootProject.findProperty("standaloneAarBuild") in [true, "true"]
// Only apply React Native plugin when building inside a React Native app (e.g. example app).
if (!isStandaloneAarBuild) {
  apply plugin: "com.facebook.react"
}

android {
  namespace "com.sherpaonnx"

  compileSdkVersion getExtOrDefault("compileSdkVersion")

  // Native .so and headers: filled by prebuilt-download.gradle (local jniLibs, Maven AAR, or GitHub release).
  // Alternatively by third_party/*/copy_prebuilts_to_sdk.js or shipped in npm package.

  // Codegen Java output: always use the flat path. For app builds RNGP writes here directly;
  // for standalone AAR builds the codegen task normalises the nested output to this path.
  sourceSets.main.java.srcDirs += file("${buildDir}/generated/source/codegen/java")

  defaultConfig {
    minSdkVersion getExtOrDefault("minSdkVersion")
    targetSdkVersion getExtOrDefault("targetSdkVersion")

    // ProGuard rules to preserve classes/methods called from JNI
    consumerProguardFiles 'proguard-rules.pro'

    // NDK configuration
    ndkVersion getExtOrDefault("ndkVersion")
    externalNativeBuild {
      cmake {
        cppFlags "-std=c++17", "-Wall", "-Wextra", "-fvisibility=hidden"
        arguments "-DANDROID_STL=c++_shared"
      }
    }

    // Supported ABIs
    ndk {
      abiFilters "arm64-v8a", "armeabi-v7a", "x86", "x86_64"
    }
  }

  buildFeatures {
    buildConfig true
  }

  // CMake configuration
  externalNativeBuild {
    cmake {
      path "src/main/cpp/CMakeLists.txt"
      version "3.22.1"
    }
  }

  buildTypes {
    release {
      minifyEnabled false
    }
  }

  lint {
    disable "GradleCompatible"
  }

  compileOptions {
    sourceCompatibility JavaVersion.VERSION_17
    targetCompatibility JavaVersion.VERSION_17
  }

  kotlinOptions {
    jvmTarget = '17'
  }
}

repositories {
  mavenCentral()
  google()
  maven { url "https://xdcobra.github.io/maven" }
}

// Configurations used by prebuilt-download.gradle: downloadNativeLibsIfNeeded (AAR → jniLibs + headers)
// and extractSherpaOnnxClasses (sherpa-onnx classes.jar). Main artifact = Kotlin API; do not use classifier "java".
configurations { sherpaOnnxAar; ffmpegAar; libarchiveAar }

// Registers downloadNativeLibsIfNeeded, checkJniLibs, extractSherpaOnnxClasses; wires preBuild.dependsOn checkJniLibs.
apply from: file("${project.projectDir}/prebuilt-download.gradle")

def kotlin_version = getExtOrDefault("kotlinVersion")

dependencies {
  // React Native dependency: explicit version ensures IDE (VS Code Kotlin LSP) and standalone
  // AAR builds can resolve com.facebook.react types. When consumed by a React Native app,
  // Gradle's dependency resolution picks the app's react-android version (typically higher).
  implementation "com.facebook.react:react-android:0.83.0"
  implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version"

  // Versions from prebuilt-versions.gradle; AARs used by prebuilt-download.gradle tasks.
  sherpaOnnxAar "com.xdcobra.sherpa:sherpa-onnx:${sherpaOnnxVersion}@aar"
  ffmpegAar "com.xdcobra.sherpa:ffmpeg:${ffmpegVersion}@aar"
  libarchiveAar "com.xdcobra.sherpa:libarchive:${libarchiveVersion}@aar"

  // sherpa-onnx Java API: extractSherpaOnnxClasses (in prebuilt-download.gradle) fills sherpaOnnxClassesDir.
  // Source: local third_party | Maven AAR | GitHub release. Native .so from same prebuilt pipeline.
  implementation fileTree(dir: sherpaOnnxClassesDir, include: '*.jar').builtBy(tasks.named('extractSherpaOnnxClasses'))

  // Play Asset Delivery: optional for getAssetPackPath (returns null if not used)
  implementation "com.google.android.play:asset-delivery:2.3.0"

  // ORT Java API (OrtEnvironment, OrtProvider) for getAvailableProviders().
  // compileOnly: the app provides the actual onnxruntime AAR at runtime.
  // Version must exist on https://xdcobra.github.io/maven.
  compileOnly "com.xdcobra.sherpa:onnxruntime:1.24.2-qnn2.43.1.260218"
}

// TurboModule codegen; separate script to avoid Gradle 9 Groovy "source is null" with NodeTask.
apply from: file("${project.projectDir}/codegen.gradle")

// Wire prebuilt tasks: extractSherpaOnnxClasses → downloadNativeLibsIfNeeded when not standalone;
// CMake/compile tasks depend on extractSherpaOnnxClasses and checkJniLibs.
afterEvaluate {
  if (!isStandaloneAarBuild && tasks.findByName("downloadNativeLibsIfNeeded") != null) {
    tasks.named("extractSherpaOnnxClasses").configure { dependsOn tasks.named("downloadNativeLibsIfNeeded") }
  }
  tasks.matching { it.name.contains("configureCMake") || it.name.contains("externalNativeBuild") }.configureEach {
    dependsOn tasks.named("extractSherpaOnnxClasses")
    dependsOn tasks.named("checkJniLibs")
  }

  // With includesGeneratedCode=false, codegen is always run by our custom task (not RNGP).
  // Kotlin compile must depend on it for both standalone AAR and app-dependency builds.
  def codegenJavaDir = project.file("${project.buildDir}/generated/source/codegen/java")
  tasks.matching { it.name == "compileReleaseKotlin" || it.name == "compileDebugKotlin" }.configureEach {
    dependsOn tasks.named("extractSherpaOnnxClasses")
    dependsOn tasks.named('generateCodegenSpec')
    inputs.dir(codegenJavaDir)
  }
}